name: Setup Grafana on VPS

on:
  workflow_dispatch:

jobs:
  setup-grafana:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy installation script to VPS
        run: |
          cat > install-grafana.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e

          echo "üîß Grafana Installation gestartet..."

          # Grafana Repository hinzuf√ºgen
          apt-get update
          apt-get install -y apt-transport-https software-properties-common wget
          wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
          echo "deb https://packages.grafana.com/oss/deb stable main" | tee /etc/apt/sources.list.d/grafana.list

          # Grafana installieren
          apt-get update
          apt-get install -y grafana

          # PostgreSQL User f√ºr Grafana erstellen (KORREKTE SYNTAX)
          sudo -u postgres psql << 'SQL_EOF'
          SELECT 'CREATE DATABASE grafana'
          WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'grafana')\gexec

          DO $$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'grafana') THEN
              CREATE USER grafana WITH ENCRYPTED PASSWORD 'GRAFANA_DB_PASS_PLACEHOLDER';
            END IF;
          END $$;

          GRANT ALL PRIVILEGES ON DATABASE grafana TO grafana;
          \c grafana
          GRANT ALL ON SCHEMA public TO grafana;
          SQL_EOF

          # Warte bis PostgreSQL bereit ist
          sleep 2

          # Grafana konfigurieren (OHNE PostgreSQL Backend - nutzt SQLite)
          cat > /etc/grafana/grafana.ini << 'GRAFANA_EOF'
          [server]
          protocol = http
          http_port = 3000
          domain = infra.markt.ma
          root_url = %(protocol)s://%(domain)s:%(http_port)s/

          [security]
          admin_user = admin
          admin_password = GRAFANA_ADMIN_PASS_PLACEHOLDER

          [database]
          type = sqlite3
          path = /var/lib/grafana/grafana.db

          [log]
          mode = console file
          level = info
          GRAFANA_EOF

          # Passwort ersetzen
          sed -i "s/GRAFANA_ADMIN_PASS_PLACEHOLDER/$1/g" /etc/grafana/grafana.ini

          # Grafana Verzeichnis-Berechtigungen
          chown -R grafana:grafana /var/lib/grafana
          chown -R grafana:grafana /var/log/grafana
          chmod 755 /var/lib/grafana

          # Grafana aktivieren und starten
          systemctl daemon-reload
          systemctl enable grafana-server
          systemctl start grafana-server

          # Warte bis Grafana hochgefahren ist
          sleep 5

          # Pr√ºfe ob Grafana l√§uft
          if ! systemctl is-active --quiet grafana-server; then
            echo "‚ùå Grafana konnte nicht gestartet werden!"
            journalctl -u grafana-server -n 50 --no-pager
            exit 1
          fi

          # Nginx Konfiguration f√ºr Grafana
          cat > /etc/nginx/sites-available/grafana << 'NGINX_EOF'
          server {
              listen 80;
              server_name infra.markt.ma;

              location / {
                  proxy_pass http://localhost:3000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
              }
          }
          NGINX_EOF

          ln -sf /etc/nginx/sites-available/grafana /etc/nginx/sites-enabled/
          nginx -t && systemctl reload nginx

          # SSL mit Certbot
          if certbot --nginx -d infra.markt.ma --non-interactive --agree-tos --email "$2" 2>&1; then
            echo "‚úÖ SSL erfolgreich konfiguriert"
          else
            echo "‚ö†Ô∏è Certbot fehlgeschlagen - DNS pr√ºfen oder manuell ausf√ºhren"
          fi

          echo "‚úÖ Grafana Installation abgeschlossen!"
          echo "üìç URL: https://infra.markt.ma"
          echo "üë§ User: admin"
          echo "üîë Pass: (siehe GRAFANA_ADMIN_PASSWORD Secret)"

          systemctl status grafana-server --no-pager -l
          SCRIPT_EOF

          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no install-grafana.sh root@${{ secrets.VPS_HOST }}:/tmp/

      - name: Execute installation script
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} \
            "bash /tmp/install-grafana.sh '${{ secrets.GRAFANA_ADMIN_PASSWORD }}' '${{ secrets.SSL_EMAIL }}'"

      - name: Verify installation
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          echo "üîç Grafana Status:"
          systemctl is-active grafana-server
          
          echo "üîç Nginx Status:"
          systemctl is-active nginx
          
          echo "üîç Port 3000:"
          netstat -tlnp | grep 3000 || echo "Port nicht offen"
          
          echo "‚úÖ Grafana erreichbar unter: https://infra.markt.ma"
          EOF
