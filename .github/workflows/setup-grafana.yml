name: Setup Grafana on VPS

on:
  workflow_dispatch:

jobs:
  setup-grafana:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy installation script to VPS
        run: |
          cat > install-grafana.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸ”§ Grafana Installation gestartet..."
          
          # Grafana Repository hinzufÃ¼gen
          apt-get update
          apt-get install -y apt-transport-https software-properties-common wget
          wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
          echo "deb https://packages.grafana.com/oss/deb stable main" | tee /etc/apt/sources.list.d/grafana.list
          
          # Grafana installieren
          apt-get update
          apt-get install -y grafana
          
          # PostgreSQL User fÃ¼r Grafana erstellen
          sudo -u postgres psql << 'SQL_EOF'
          CREATE DATABASE IF NOT EXISTS grafana;
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'grafana') THEN
              CREATE USER grafana WITH ENCRYPTED PASSWORD 'GRAFANA_DB_PASS_PLACEHOLDER';
            END IF;
          END
          $$;
          GRANT ALL PRIVILEGES ON DATABASE grafana TO grafana;
          SQL_EOF
          
          # Grafana konfigurieren
          cat > /etc/grafana/grafana.ini << 'GRAFANA_EOF'
          [server]
          protocol = http
          http_port = 3000
          domain = infra.markt.ma
          root_url = %(protocol)s://%(domain)s:%(http_port)s/
          
          [security]
          admin_user = admin
          admin_password = GRAFANA_ADMIN_PASS_PLACEHOLDER
          
          [database]
          type = postgres
          host = localhost:5432
          name = grafana
          user = grafana
          password = GRAFANA_DB_PASS_PLACEHOLDER
          GRAFANA_EOF
          
          # PasswÃ¶rter ersetzen
          sed -i "s/GRAFANA_ADMIN_PASS_PLACEHOLDER/$1/g" /etc/grafana/grafana.ini
          sed -i "s/GRAFANA_DB_PASS_PLACEHOLDER/$2/g" /etc/grafana/grafana.ini
          
          # Grafana aktivieren und starten
          systemctl daemon-reload
          systemctl enable grafana-server
          systemctl restart grafana-server
          
          # Nginx Konfiguration fÃ¼r Grafana
          cat > /etc/nginx/sites-available/grafana << 'NGINX_EOF'
          server {
              listen 80;
              server_name infra.markt.ma;
          
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINX_EOF
          
          ln -sf /etc/nginx/sites-available/grafana /etc/nginx/sites-enabled/
          nginx -t && systemctl reload nginx
          
          # SSL mit Certbot
          certbot --nginx -d infra.markt.ma --non-interactive --agree-tos --email "$3" || echo "âš ï¸ Certbot fehlgeschlagen - DNS prÃ¼fen"
          
          echo "âœ… Grafana Installation abgeschlossen!"
          systemctl status grafana-server --no-pager
          SCRIPT_EOF
          
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no install-grafana.sh root@${{ secrets.VPS_HOST }}:/tmp/

      - name: Execute installation script
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} \
            "bash /tmp/install-grafana.sh '${{ secrets.GRAFANA_ADMIN_PASSWORD }}' '${{ secrets.GRAFANA_DB_PASSWORD }}' '${{ secrets.SSL_EMAIL }}'"

      - name: Verify installation
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          echo "ğŸ” Grafana Status:"
          systemctl is-active grafana-server
          
          echo "ğŸ” Nginx Status:"
          systemctl is-active nginx
          
          echo "ğŸ” Port 3000:"
          netstat -tlnp | grep 3000 || echo "Port nicht offen"
          
          echo "âœ… Grafana erreichbar unter: https://infra.markt.ma"
          EOF
