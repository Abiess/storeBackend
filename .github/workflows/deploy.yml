name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Deploy to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/*.jar"
          target: "/tmp"
          strip_components: 1

      - name: Upload deployment scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "scripts/"
          target: "/opt/storebackend/"
          strip_components: 0

      - name: Execute deployment script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # Make scripts executable
            chmod +x /opt/storebackend/scripts/*.sh
            
            # Export SMTP configuration from GitHub Secrets
            export SMTP_HOST="${{ secrets.SMTP_HOST }}"
            export SMTP_PORT="${{ secrets.SMTP_PORT }}"
            export SMTP_USER="${{ secrets.SMTP_USER }}"
            export SMTP_PASS="${{ secrets.SMTP_PASS }}"
            export MAIL_FROM="${{ secrets.MAIL_FROM }}"
            export APP_BASE_URL="${{ secrets.APP_BASE_URL }}"
            export MAIL_ENABLED="true"
            
            # Export other required secrets
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            
            # Execute deployment
            cd /opt/storebackend
            bash scripts/deploy.sh

      - name: Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 10m
          script: |
            set -e
            echo "üè• Waiting for app..."
            
            for i in $(seq 1 30); do
              HTTP_CODE=$(curl -fsS -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
            
              if [ "$HTTP_CODE" = "200" ]; then
                echo "‚úÖ Healthy"
                curl -fsS http://localhost:8080/actuator/health
                exit 0
              fi
            
              echo "‚è≥ Attempt $i/30 (HTTP $HTTP_CODE)..."
            
              # Auto-recovery bei 503 (Service Unavailable)
              if [ "$HTTP_CODE" = "503" ] && [ "$i" -eq 10 ]; then
                echo "‚ö†Ô∏è  HTTP 503 detected - attempting auto-recovery..."
                echo "üîß Step 1: Checking PostgreSQL..."
                if sudo systemctl is-active --quiet postgresql; then
                  echo "   ‚úÖ PostgreSQL is responding"
                else
                  echo "   ‚ùå PostgreSQL is not running - starting..."
                  sudo systemctl start postgresql
                  sleep 3
                fi
            
                echo "üîß Step 2: Restarting StoreBackend service..."
                sudo systemctl restart storebackend
                echo "   ‚úÖ Service restarted, continuing health checks..."
                sleep 5
              fi
            
              sleep 2
            done
            
            echo "‚ùå Health check failed after 30 attempts"
            echo "üìä Service Status:"
            sudo systemctl status storebackend --no-pager || true
            echo ""
            echo "‚ùå Last 120 log lines:"
            sudo journalctl -u storebackend -n 120 --no-pager || true
            exit 1
