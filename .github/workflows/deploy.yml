name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: üîß Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: üì¶ Prepare JAR for Deployment
        run: |
          # Find the built JAR file
          JAR_FILE=$(find target -name "*SNAPSHOT.jar" -o -name "storeBackend*.jar" | grep -v javadoc | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå No JAR file found in target directory!"
            echo "üìÅ Contents of target directory:"
            ls -lah target/ || echo "target directory is empty or doesn't exist"
            exit 1
          fi

          JAR_SIZE=$(stat --format=%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
          echo "Found JAR: $(basename "$JAR_FILE") ($(numfmt --to=iec $JAR_SIZE 2>/dev/null || du -h "$JAR_FILE" | cut -f1))"

          # Create app.jar as a copy (stable name, but we will also handle dynamic names)
          cp "$JAR_FILE" target/app.jar || true

          echo "Contents of target after build:"
          ls -lah target/

      - name: üöÄ Deploy JAR to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          # Send all relevant jars to be safe
          source: "target/*.jar"
          target: "/tmp/"

      - name: üìã Copy Deploy Script to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "scripts/deploy.sh"
          target: "/tmp/"

      - name: ‚úÖ Verify JAR Transfer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "üîç Checking for JAR file in /tmp..."

            # Prefer app.jar if it exists
            if [ -f /tmp/app.jar ]; then
              APP_SIZE=$(stat --format=%s /tmp/app.jar 2>/dev/null || stat -f%z /tmp/app.jar 2>/dev/null)
              echo "‚úÖ app.jar found! Size: $(numfmt --to=iec $APP_SIZE 2>/dev/null || du -h /tmp/app.jar | cut -f1)"
              exit 0
            fi

            # Otherwise, accept any JAR file
            JAR_FILE=$(find /tmp -maxdepth 1 -name "*.jar" -type f 2>/dev/null | head -n 1)
            if [ -n "$JAR_FILE" ]; then
              JAR_SIZE=$(stat --format=%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
              echo "‚úÖ Found JAR: $(basename "$JAR_FILE") (Size: $(numfmt --to=iec $JAR_SIZE 2>/dev/null || du -h "$JAR_FILE" | cut -f1))"
              echo "üìÅ All JAR files in /tmp:"
              find /tmp -maxdepth 1 -name "*.jar" -type f 2>/dev/null
              exit 0
            fi

            echo "‚ùå No JAR file found in /tmp!"
            echo "üìÅ All files in /tmp:"
            ls -lah /tmp/ | head -30
            exit 1

      - name: üîß Setup VPS Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "üîß Preparing VPS environment..."

            # Create base directory and subdirectories if they don't exist
            sudo mkdir -p /opt/storebackend
            sudo mkdir -p /opt/storebackend/backups
            sudo mkdir -p /opt/storebackend/logs

            # Create storebackend user if it doesn't exist
            if ! id -u storebackend > 4 /dev/null 2>&1; then
              echo "Creating storebackend user..."
              sudo useradd -r -s /bin/bash storebackend
            fi

            # Move deploy.sh to /opt/storebackend if present
            if [ -f /tmp/deploy.sh ]; then
              echo "Moving deploy.sh to /opt/storebackend..."
              sudo mv /tmp/deploy.sh /opt/storebackend/deploy.sh
            else
              echo "‚ö†Ô∏è  /tmp/deploy.sh not found!"
            fi

            # Find any JAR in /tmp and move it as app.jar
            JAR_FILE=$(find /tmp -maxdepth 1 -name "*.jar" -type f 2>/dev/null | head -n 1)
            if [ -n "$JAR_FILE" ]; then
              echo "Moving $(basename "$JAR_FILE") to /opt/storebackend/app.jar..."
              sudo mv "$JAR_FILE" /opt/storebackend/app.jar
            else
              echo "‚ö†Ô∏è  No JAR file found in /tmp to move!"
            fi

            # Set permissions and ownership
            sudo chown -R storebackend:storebackend /opt/storebackend
            sudo chmod 755 /opt/storebackend

            # Ensure deploy.sh is executable
            if [ -f /opt/storebackend/deploy.sh ]; then
              sudo chmod +x /opt/storebackend/deploy.sh
            else
              echo "‚ö†Ô∏è  /opt/storebackend/deploy.sh not found!"
            fi

            echo "‚úÖ VPS environment ready"

      - name: üîÑ Execute Deployment
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD,JWT_SECRET
          script: |
            # Export environment variables
            export DB_PASSWORD="${DB_PASSWORD}"
            export JWT_SECRET="${JWT_SECRET}"

            # Start deployment
            cd /opt/storebackend

            if [ ! -x ./deploy.sh ]; then
              echo "‚ùå /opt/storebackend/deploy.sh is missing or not executable"
              ls -lah .
              exit 1
            fi

            ./deploy.sh

      - name: üè• Final Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking application health..."
            sleep 5
            curl -f http://localhost:8080/actuator/health || exit 1
            echo "‚úÖ Application is ru
