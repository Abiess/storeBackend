name: Deploy Backend to VPS (Pure Schema - NO FLYWAY)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: ğŸ”§ Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: ğŸ“¦ Prepare JAR for Deployment
        run: |
          JAR_FILE=$(find target -name "*SNAPSHOT.jar" -o -name "storeBackend*.jar" | grep -v javadoc | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "âŒ No JAR file found in target directory!"
            ls -lah target/ || true
            exit 1
          fi

          JAR_SIZE=$(stat --format=%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
          echo "Found JAR: $(basename "$JAR_FILE") ($(numfmt --to=iec $JAR_SIZE 2>/dev/null || du -h "$JAR_FILE" | cut -f1))"

          cp "$JAR_FILE" target/app.jar
          test -f target/app.jar

          echo "âœ… Created target/app.jar for deployment"
          ls -lah target/

      - name: ğŸš€ Deploy JAR to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/app.jar"
          target: "/tmp/"
          strip_components: 1

      - name: ğŸ” Debug - Verify required files
        run: |
          echo "PWD: $(pwd)"
          echo ""
          echo "âœ… Required files for Pure Schema deployment:"
          ls -lah scripts/deploy-no-flyway.sh
          ls -lah scripts/db/schema.sql
          echo ""
          echo "âœ… All files present"

      - name: ğŸ“‹ Copy schema.sql and deploy script to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "scripts/db/schema.sql,scripts/deploy-no-flyway.sh"
          target: "/tmp/"
          strip_components: 1

      - name: âœ… Verify JAR Transfer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ” Checking for app.jar in /tmp..."
            test -f /tmp/app.jar
            ls -lah /tmp/app.jar

      - name: ğŸ”§ Setup VPS Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ”§ Preparing VPS environment (Pure Schema - NO Flyway)..."

            sudo mkdir -p /opt/storebackend/backups
            sudo mkdir -p /opt/storebackend/logs
            sudo mkdir -p /opt/storebackend/scripts

            if ! id -u storebackend > /dev/null 2>&1; then
              sudo useradd -r -s /bin/bash storebackend
            fi

            # Move deploy script
            if [ -f /tmp/deploy-no-flyway.sh ]; then
              sudo mv /tmp/deploy-no-flyway.sh /opt/storebackend/deploy.sh
              sudo chmod +x /opt/storebackend/deploy.sh
              echo "âœ… Moved deploy script"
            fi

            # Move schema.sql
            if [ -f /tmp/schema.sql ]; then
              sudo mv /tmp/schema.sql /opt/storebackend/scripts/schema.sql
              sudo chmod 644 /opt/storebackend/scripts/schema.sql
              echo "âœ… Moved schema.sql"
            fi

            sudo chown -R storebackend:storebackend /opt/storebackend
            sudo chmod 755 /opt/storebackend

            echo "âœ… VPS environment ready (Pure Schema - NO Flyway)"
            echo "ğŸ“ Files in /opt/storebackend:"
            ls -lah /opt/storebackend/
            echo ""
            echo "ğŸ“ Files in /opt/storebackend/scripts:"
            ls -lah /opt/storebackend/scripts/ || true

      - name: ğŸ—ƒï¸ Setup PostgreSQL Database (one-time, if needed)
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD
          script: |
            set -e
            echo "ğŸ—ƒï¸ Checking PostgreSQL setup..."

            # Check if database exists
            if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw storedb; then
              echo "âœ… Database 'storedb' exists"
            else
              echo "ğŸ“¦ Creating database 'storedb'..."
              sudo -u postgres psql -c "CREATE DATABASE storedb;"
            fi

            # Check if user exists
            if sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='storeapp'" | grep -q 1; then
              echo "âœ… PostgreSQL user 'storeapp' exists"
              
              # Update password
              echo "ğŸ” Updating storeapp password..."
              sudo -u postgres psql -c "ALTER USER storeapp WITH PASSWORD '${DB_PASSWORD}';"
              
              # Grant permissions
              echo "ğŸ” Granting permissions..."
              sudo -u postgres psql -d storedb <<EOF
              GRANT ALL PRIVILEGES ON DATABASE storedb TO storeapp;
              GRANT ALL PRIVILEGES ON SCHEMA public TO storeapp;
              GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO storeapp;
              GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO storeapp;
              ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO storeapp;
              ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO storeapp;
              EOF
              
              echo "âœ… Permissions granted"
            else
              echo "ğŸ“¦ Creating PostgreSQL user 'storeapp'..."
              sudo -u postgres psql <<EOF
              CREATE USER storeapp WITH PASSWORD '${DB_PASSWORD}';
              GRANT ALL PRIVILEGES ON DATABASE storedb TO storeapp;
              \c storedb
              GRANT ALL PRIVILEGES ON SCHEMA public TO storeapp;
              ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO storeapp;
              ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO storeapp;
              EOF
              echo "âœ… User created and permissions granted"
            fi

      - name: ğŸš€ Execute Deployment (Pure Schema)
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MINIO_ENABLED: ${{ secrets.MINIO_ENABLED }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD,JWT_SECRET,MINIO_ENABLED
          command_timeout: 5m
          script: |
            set -e
            
            # Ensure environment file exists
            if [ ! -f /etc/storebackend.env ]; then
              echo "SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}" | sudo tee /etc/storebackend.env > /dev/null
              echo "JWT_SECRET=${JWT_SECRET}" | sudo tee -a /etc/storebackend.env > /dev/null
              echo "MINIO_ENABLED=${MINIO_ENABLED:-false}" | sudo tee -a /etc/storebackend.env > /dev/null
              sudo chmod 600 /etc/storebackend.env
            fi
            
            # Run deploy script (applies schema.sql and starts app)
            cd /opt/storebackend
            sudo -E ./deploy.sh

      - name: ğŸ“Š Database Status Check
        uses: appleboy/ssh-action@master
        if: success()
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š DATABASE STATUS (Pure Schema - NO Flyway)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“‹ 1. All Tables in Database:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              tablename,
              pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
            FROM pg_tables 
            WHERE schemaname = 'public' 
            ORDER BY tablename;" || echo "âš ï¸  Could not list tables"
            
            echo ""
            echo "ğŸ“‹ 2. cart_items Table Structure (should have created_at/updated_at):"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              column_name,
              data_type,
              is_nullable,
              column_default
            FROM information_schema.columns 
            WHERE table_name = 'cart_items' 
            ORDER BY ordinal_position;" || echo "âš ï¸  cart_items table not found"
            
            echo ""
            echo "ğŸ“‹ 3. Verify created_at and updated_at columns:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            CREATED_AT=$(sudo -u postgres psql -d storedb -t -c "
              SELECT EXISTS (
                SELECT 1 FROM information_schema.columns
                WHERE table_name = 'cart_items' AND column_name = 'created_at'
              );" | xargs)
            
            UPDATED_AT=$(sudo -u postgres psql -d storedb -t -c "
              SELECT EXISTS (
                SELECT 1 FROM information_schema.columns
                WHERE table_name = 'cart_items' AND column_name = 'updated_at'
              );" | xargs)
            
            if [ "$CREATED_AT" = "t" ] && [ "$UPDATED_AT" = "t" ]; then
              echo "âœ… created_at: EXISTS"
              echo "âœ… updated_at: EXISTS"
            else
              echo "âŒ created_at: $CREATED_AT"
              echo "âŒ updated_at: $UPDATED_AT"
            fi
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… DATABASE STATUS CHECK COMPLETE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ‰ Deployment Summary
        if: success()
        run: |
          echo "========================================="
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "========================================="
          echo ""
          echo "ğŸ“Š Architecture:"
          echo "   - NO Flyway"
          echo "   - Pure schema.sql (idempotent)"
          echo "   - Hibernate: validate mode"
          echo ""
          echo "ğŸ—ƒï¸ Database:"
          echo "   - Schema applied from scripts/db/schema.sql"
          echo "   - Changes via psql before deploy"
          echo ""
          echo "ğŸš€ Application:"
          echo "   - Will crash if schema mismatch (by design)"
          echo "   - Forces correct schema state"
          echo ""

      - name: âŒ Deployment Failed - Show Logs
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "========================================="
            echo "âŒ DEPLOYMENT FAILED"
            echo "========================================="
            echo ""
            echo "ğŸ“‹ Last 100 log lines:"
            sudo journalctl -u storebackend -n 100 --no-pager
            echo ""
            echo "ğŸ“‹ Systemd status:"
            sudo systemctl status storebackend --no-pager || true
