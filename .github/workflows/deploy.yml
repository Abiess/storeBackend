name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: üîß Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: üì¶ Prepare JAR for Deployment
        run: |
          JAR_FILE=$(find target -name "*SNAPSHOT.jar" -o -name "storeBackend*.jar" | grep -v javadoc | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå No JAR file found in target directory!"
            ls -lah target/ || true
            exit 1
          fi

          JAR_SIZE=$(stat --format=%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
          echo "Found JAR: $(basename "$JAR_FILE") ($(numfmt --to=iec $JAR_SIZE 2>/dev/null || du -h "$JAR_FILE" | cut -f1))"

          cp "$JAR_FILE" target/app.jar
          test -f target/app.jar

          echo "‚úÖ Created target/app.jar for deployment"
          ls -lah target/

      - name: üöÄ Deploy JAR to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/app.jar"
          target: "/tmp/"
          strip_components: 1

      - name:üîç Debug: list scripts + verify files
        run: |
          echo "PWD: $(pwd)"
          echo "Repo files:"
          ls -lah
          echo ""
          echo "scripts folder:"
          ls -lah scripts || true
          echo ""
          echo "Check required files:"
          for f in \
            scripts/deploy.sh \
            scripts/diagnose-database.sh \
            scripts/reset-database.sh \
            scripts/install-minio.sh \
            scripts/smart-db-migration.sh \
            scripts/migrate-database.sql \
            scripts/init-schema.sql \
            scripts/init-schema.sh; do
            if [ -f "$f" ]; then
              echo "‚úÖ $f"
            else
              echo "‚ùå MISSING: $f"
              exit 1
            fi
          done


      - name: üìã Copy scripts to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: |
            scripts/deploy.sh
            scripts/diagnose-database.sh
            scripts/reset-database.sh
            scripts/install-minio.sh
            scripts/smart-db-migration.sh
            scripts/migrate-database.sql
            scripts/init-schema.sql
            scripts/init-schema.sh
          target: "/tmp/"
          strip_components: 1

      - name: ‚úÖ Verify JAR Transfer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "üîç Checking for app.jar in /tmp..."
            test -f /tmp/app.jar
            ls -lah /tmp/app.jar

      - name: üîß Setup VPS Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "üîß Preparing VPS environment..."

            sudo mkdir -p /opt/storebackend/backups
            sudo mkdir -p /opt/storebackend/logs
            sudo mkdir -p /opt/storebackend/scripts

            if ! id -u storebackend > /dev/null 2>&1; then
              sudo useradd -r -s /bin/bash storebackend
            fi

            # Move deploy.sh
            if [ -f /tmp/deploy.sh ]; then
              sudo mv /tmp/deploy.sh /opt/storebackend/deploy.sh
            fi

            # Move scripts + sql
            for f in diagnose-database.sh reset-database.sh install-minio.sh smart-db-migration.sh migrate-database.sql init-schema.sql init-schema.sh; do
              if [ -f "/tmp/$f" ]; then
                sudo mv "/tmp/$f" "/opt/storebackend/scripts/$f"
              fi
            done

            sudo chown -R storebackend:storebackend /opt/storebackend
            sudo chmod 755 /opt/storebackend

            # ‚úÖ Correct chmod paths
            sudo chmod +x /opt/storebackend/deploy.sh || true
            sudo chmod +x /opt/storebackend/scripts/diagnose-database.sh || true
            sudo chmod +x /opt/storebackend/scripts/reset-database.sh || true
            sudo chmod +x /opt/storebackend/scripts/install-minio.sh || true
            sudo chmod +x /opt/storebackend/scripts/smart-db-migration.sh || true
            sudo chmod +x /opt/storebackend/scripts/init-schema.sh || true

            echo "‚úÖ VPS environment ready"
            echo "üìÅ Files in /opt/storebackend/scripts:"
            ls -lah /opt/storebackend/scripts | head -50

      - name: üóÉÔ∏è Initialize Database Schema (only if missing)
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD
          script: |
            set -e
            echo "üóÉÔ∏è  Checking if DB has users table..."
            if sudo -u postgres psql -d storedb -tAc "SELECT to_regclass('public.users')" | grep -q users; then
              echo "‚úÖ users table exists, skipping init-schema"
              exit 0
            fi

            echo "üÜï users missing -> initializing schema..."
            test -f /opt/storebackend/scripts/init-schema.sql
            sudo -u postgres psql -d storedb -f /opt/storebackend/scripts/init-schema.sql
            echo "‚úÖ Schema initialized"

      - name: üîÑ Execute Deployment
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD,JWT_SECRET
          script: |
            set -e
            export DB_PASSWORD="${DB_PASSWORD}"
            export JWT_SECRET="${JWT_SECRET}"

            cd /opt/storebackend
            test -x ./deploy.sh
            ./deploy.sh

      - name: üè• Final Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            sleep 5
            curl -f http://localhost:8080/actuator/health
            echo "‚úÖ Application is running!"
