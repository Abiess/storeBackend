name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: ğŸ”§ Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: ğŸ” Validate Flyway Migrations
        run: |
          chmod +x scripts/validate-migrations.sh
          ./scripts/validate-migrations.sh

      - name: ğŸ“¦ Prepare JAR for Deployment
        run: |
          JAR_FILE=$(find target -name "*SNAPSHOT.jar" -o -name "storeBackend*.jar" | grep -v javadoc | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "âŒ No JAR file found in target directory!"
            ls -lah target/ || true
            exit 1
          fi

          JAR_SIZE=$(stat --format=%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
          echo "Found JAR: $(basename "$JAR_FILE") ($(numfmt --to=iec $JAR_SIZE 2>/dev/null || du -h "$JAR_FILE" | cut -f1))"

          cp "$JAR_FILE" target/app.jar
          test -f target/app.jar

          echo "âœ… Created target/app.jar for deployment"
          ls -lah target/

      - name: ğŸš€ Deploy JAR to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/app.jar"
          target: "/tmp/"
          strip_components: 1

      - name: "ğŸ” Debug: list scripts + verify files"
        run: |
          echo "PWD: $(pwd)"
          echo "Repo files:"
          ls -lah
          echo ""
          echo "scripts folder:"
          ls -lah scripts || true
          echo ""
          echo "Check required files (Flyway-based):"
          for f in \
            scripts/deploy.sh \
            scripts/diagnose-database.sh \
            scripts/flyway-helper.sh \
            scripts/setup-postgres-user.sh \
            scripts/install-minio.sh \
            scripts/fix-db-password.sh \
            scripts/check-server-error.sh \
            scripts/diagnose-v17-migration.sh ; do
            if [ -f "$f" ]; then
              echo "âœ… $f"
            else
              echo "âŒ MISSING: $f"
              exit 1
            fi
          done
          echo ""
          echo "âœ… All required Flyway-based scripts present"

      - name: ğŸ“‹ Copy scripts to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "scripts/deploy.sh,scripts/diagnose-database.sh,scripts/flyway-helper.sh,scripts/setup-postgres-user.sh,scripts/install-minio.sh,scripts/fix-db-password.sh,scripts/check-server-error.sh,scripts/diagnose-v17-migration.sh"
          target: "/tmp/"
          strip_components: 1

      - name: âœ… Verify JAR Transfer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ” Checking for app.jar in /tmp..."
            test -f /tmp/app.jar
            ls -lah /tmp/app.jar

      - name: ğŸ”§ Setup VPS Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ”§ Preparing VPS environment..."

            sudo mkdir -p /opt/storebackend/backups
            sudo mkdir -p /opt/storebackend/logs
            sudo mkdir -p /opt/storebackend/scripts

            if ! id -u storebackend > /dev/null 2>&1; then
              sudo useradd -r -s /bin/bash storebackend
            fi

            # Move deploy.sh
            if [ -f /tmp/deploy.sh ]; then
              sudo mv /tmp/deploy.sh /opt/storebackend/deploy.sh
            fi

            # Move Flyway-based scripts
            for f in diagnose-database.sh flyway-helper.sh setup-postgres-user.sh install-minio.sh fix-db-password.sh check-server-error.sh diagnose-v17-migration.sh ; do
              if [ -f "/tmp/$f" ]; then
                sudo mv "/tmp/$f" "/opt/storebackend/scripts/$f"
                echo "âœ… Moved $f"
              fi
            done

            sudo chown -R storebackend:storebackend /opt/storebackend
            sudo chmod 755 /opt/storebackend

            # Make scripts executable
            sudo chmod +x /opt/storebackend/deploy.sh || true
            sudo chmod +x /opt/storebackend/scripts/diagnose-database.sh || true
            sudo chmod +x /opt/storebackend/scripts/flyway-helper.sh || true
            sudo chmod +x /opt/storebackend/scripts/setup-postgres-user.sh || true
            sudo chmod +x /opt/storebackend/scripts/install-minio.sh || true
            sudo chmod +x /opt/storebackend/scripts/fix-db-password.sh || true
            sudo chmod +x /opt/storebackend/scripts/check-server-error.sh || true
            sudo chmod +x /opt/storebackend/scripts/diagnose-v17-migration.sh || true


            echo "âœ… VPS environment ready (Flyway-based)"
            echo "ğŸ“ Files in /opt/storebackend/scripts:"
            ls -lah /opt/storebackend/scripts | head -50

      - name: ğŸ—ƒï¸ Setup PostgreSQL Database (one-time, if needed)
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD
          script: |
            set -e
            echo "ğŸ—ƒï¸ Checking PostgreSQL setup..."

            # PrÃ¼fe ob storeapp User existiert
            if sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='storeapp'" | grep -q 1; then
              echo "âœ… PostgreSQL user 'storeapp' exists"

              # Stoppe App um Locks zu vermeiden
              sudo systemctl stop storebackend || true
              sleep 2

              # WICHTIG: Setze Permissions VOR Flyway (verhindert V3 Lock)
              echo "ğŸ” Setting complete permissions (outside Flyway to avoid locks)..."
              cd /opt/storebackend
              export DB_PASSWORD="${DB_PASSWORD}"
              sudo -E ./scripts/fix-db-password.sh

              echo "âœ… Permissions set"


            else
              echo "ğŸ†• Creating PostgreSQL user and database..."
              cd /opt/storebackend
              export DB_PASSWORD="${DB_PASSWORD}"
              sudo -E ./scripts/setup-postgres-user.sh
            fi

            echo "âœ… PostgreSQL ready - Flyway will handle schema migrations"

      - name: ğŸ”„ Execute Deployment
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FLYWAY_BASELINE_ON_MIGRATE: "true"   # âœ… Baseline bei V16, dann V17 ausfÃ¼hren
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD,JWT_SECRET,FLYWAY_BASELINE_ON_MIGRATE
          script: |
            set -e
            export DB_PASSWORD="${DB_PASSWORD}"
            export JWT_SECRET="${JWT_SECRET}"
            export FLYWAY_BASELINE_ON_MIGRATE="${FLYWAY_BASELINE_ON_MIGRATE}"

            cd /opt/storebackend
            test -x ./deploy.sh
            ./deploy.sh
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š DATABASE STATUS AFTER DEPLOYMENT"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            echo ""
            echo "ğŸ“‹ 1. Flyway Migration History:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              installed_rank AS rank,
              version,
              description,
              type,
              script,
              installed_on,
              execution_time AS exec_time_ms,
              success
            FROM flyway_schema_history 
            ORDER BY installed_rank;" || echo "âš ï¸  flyway_schema_history table not found"
            
            echo ""
            echo "ğŸ“‹ 2. All Tables in Database:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              schemaname,
              tablename,
              pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
              (SELECT COUNT(*) FROM information_schema.columns 
               WHERE table_schema = schemaname AND table_name = tablename) AS column_count
            FROM pg_tables 
            WHERE schemaname = 'public' 
            ORDER BY tablename;" || echo "âš ï¸  Could not list tables"
            
            echo ""
            echo "ğŸ“‹ 3. Media Table Structure (wichtig fÃ¼r content_type):"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              column_name,
              data_type,
              character_maximum_length,
              is_nullable,
              column_default
            FROM information_schema.columns 
            WHERE table_name = 'media' 
            ORDER BY ordinal_position;" || echo "âš ï¸  Media table not found"
            
            echo ""
            echo "ğŸ“‹ 4. Store Domains Table Structure:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              column_name,
              data_type,
              character_maximum_length,
              is_nullable,
              column_default
            FROM information_schema.columns 
            WHERE table_name = 'store_domains' 
            ORDER BY ordinal_position;" || echo "âš ï¸  Store_domains table not found"
            
            echo ""
            echo "ğŸ“‹ 5. Users Table Structure:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              column_name,
              data_type,
              is_nullable
            FROM information_schema.columns 
            WHERE table_name = 'users' 
            ORDER BY ordinal_position;" || echo "âš ï¸  Users table not found"
            
            echo ""
            echo "ğŸ“‹ 6. Stores Table Structure:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              column_name,
              data_type,
              is_nullable
            FROM information_schema.columns 
            WHERE table_name = 'stores' 
            ORDER BY ordinal_position;" || echo "âš ï¸  Stores table not found"
            
            echo ""
            echo "ğŸ“‹ 7. Row Counts (should be empty after fresh migration):"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            for table in users stores products categories orders order_items cart_items media store_domains; do
              count=$(sudo -u postgres psql -d storedb -t -c "SELECT COUNT(*) FROM $table;" 2>/dev/null | xargs || echo "N/A")
              printf "%-20s : %s rows\n" "$table" "$count"
            done
            
            echo ""
            echo "ğŸ“‹ 8. Flyway & Migration Logs from Application:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo journalctl -u storebackend -n 500 --no-pager \
            | grep -iE "flyway|migrat|schema_history|validate|baseline|V1__initial" || echo "No Flyway logs found"
            
            echo ""
            echo "ğŸ“‹ 9. Content-Type Column Check (should exist):"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            sudo -u postgres psql -d storedb -c "
            SELECT 
              EXISTS (
                SELECT 1 
                FROM information_schema.columns 
                WHERE table_name = 'media' AND column_name = 'content_type'
              ) AS content_type_exists;" || echo "âš ï¸  Could not check content_type"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… DATABASE STATUS CHECK COMPLETE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

      - name: ğŸ¥ Final Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ¥ Warte auf Anwendungsstart (inkl. Flyway Migrationen)..."
            echo "â±ï¸  Timeout: 240 Sekunden (4 Minuten)"

            MAX_ATTEMPTS=8
            SLEEP_TIME=5

            for i in $(seq 1 $MAX_ATTEMPTS); do
              ELAPSED=$((i * SLEEP_TIME))
              echo "â³ Versuch $i/$MAX_ATTEMPTS (${ELAPSED}s / 40s)..."

              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo ""
                echo "âœ… Application is running!"
                echo "ğŸ“Š Health Status:"
                curl -s http://localhost:8080/actuator/health | jq '.' 2>/dev/null || curl -s http://localhost:8080/actuator/health
                echo ""
                echo "â±ï¸  Started after ${ELAPSED} seconds"
                exit 0
              fi

              if [ $i -lt $MAX_ATTEMPTS ]; then
                sleep $SLEEP_TIME
              fi
            done

            echo ""
            echo "âŒ Application nicht erreichbar nach 240 Sekunden"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” RUNNING AUTOMATIC DIAGNOSTICS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“‹ 1. Running check-server-error.sh..."
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            /opt/storebackend/scripts/check-server-error.sh || true
            echo ""
            echo "ğŸ“‹ 2. Running diagnose-v17-migration.sh..."
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            /opt/storebackend/scripts/diagnose-v17-migration.sh || true
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“‹ SYSTEMD STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            sudo systemctl status storebackend --no-pager --lines=50 || true
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“‹ LETZTE 200 LOG-ZEILEN (journalctl)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            sudo journalctl -u storebackend -n 200 --no-pager || true
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ’¡ TROUBLESHOOTING TIPPS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "1. PrÃ¼fe Flyway-Migration-Logs auf Fehler (siehe oben)"
            echo "2. PrÃ¼fe DB-Verbindung: sudo /opt/storebackend/scripts/diagnose-database.sh"
            echo "3. PrÃ¼fe DB-Rechte: sudo /opt/storebackend/scripts/fix-db-password.sh"
            echo "4. PrÃ¼fe MinIO Status: sudo systemctl status minio"
            echo "5. PrÃ¼fe Schema-Validation: sudo journalctl -u storebackend | grep -i schema"
            echo ""
            exit 1
