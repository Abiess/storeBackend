name: Deploy Backend to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: ğŸ”§ Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: ğŸ“¦ Prepare JAR for Deployment
        run: |
          set -e
          JAR_FILE=$(find target -maxdepth 1 -type f \( -name "*SNAPSHOT.jar" -o -name "storeBackend*.jar" \) | grep -v javadoc | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "âŒ No JAR file found in target directory!"
            ls -lah target/ || true
            exit 1
          fi

          cp "$JAR_FILE" target/app.jar
          test -f target/app.jar
          ls -lah target/app.jar
          echo "âœ… Prepared target/app.jar"

      - name: ğŸš€ Deploy JAR to VPS (/tmp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/app.jar"
          target: "/tmp/"
          strip_components: 1

      - name: ğŸ“‹ Copy deploy script to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "scripts/deploy.sh"
          target: "/tmp/"
          strip_components: 1

      - name: âœ… Verify JAR Transfer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ” Checking /tmp/app.jar..."
            test -f /tmp/app.jar
            ls -lah /tmp/app.jar
            echo "ğŸ” Checking /tmp/deploy.sh..."
            test -f /tmp/deploy.sh
            ls -lah /tmp/deploy.sh

      - name: ğŸ”§ Setup VPS Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ”§ Preparing VPS environment..."

            sudo mkdir -p /opt/storebackend/{backups,logs,scripts}

            if ! id -u storebackend >/dev/null 2>&1; then
              sudo useradd -r -s /bin/bash storebackend
            fi

            if [ -f /tmp/deploy.sh ]; then
              sudo mv /tmp/deploy.sh /opt/storebackend/deploy.sh
              sudo chmod +x /opt/storebackend/deploy.sh
            fi

            sudo chown -R storebackend:storebackend /opt/storebackend
            sudo chmod 755 /opt/storebackend

            echo "âœ… VPS ready:"
            ls -lah /opt/storebackend

      - name: ğŸ—ƒï¸ Setup PostgreSQL Database (idempotent)
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD
          script: |
            set -euo pipefail

            echo "ğŸ—ƒï¸ Ensuring database and user exist..."

            # Create DB if missing
            if ! sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='storedb'" | grep -q 1; then
              echo "ğŸ“¦ Creating database storedb..."
              sudo -u postgres psql -c "CREATE DATABASE storedb;"
            else
              echo "âœ… Database storedb exists"
            fi

            # Create user if missing
            if ! sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='storeapp'" | grep -q 1; then
              echo "ğŸ“¦ Creating role storeapp..."
              sudo -u postgres psql -c "CREATE USER storeapp WITH PASSWORD '${DB_PASSWORD}';"
            else
              echo "âœ… Role storeapp exists"
              echo "ğŸ” Updating password for storeapp..."
              sudo -u postgres psql -c "ALTER USER storeapp WITH PASSWORD '${DB_PASSWORD}';"
            fi

            echo "ğŸ” Granting privileges..."
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE storedb TO storeapp;"
            sudo -u postgres psql -d storedb -c "GRANT ALL PRIVILEGES ON SCHEMA public TO storeapp;"
            sudo -u postgres psql -d storedb -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO storeapp;"
            sudo -u postgres psql -d storedb -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO storeapp;"
            sudo -u postgres psql -d storedb -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO storeapp;"
            sudo -u postgres psql -d storedb -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO storeapp;"

            echo "âœ… DB setup done"

      - name: ğŸš€ Execute Deployment
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MINIO_ENABLED: ${{ secrets.MINIO_ENABLED }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DB_PASSWORD,JWT_SECRET,MINIO_ENABLED
          script: |
            set -e
            echo "ğŸš€ Deploying..."
            cd /opt/storebackend
            sudo -E bash deploy.sh

      - name: ğŸ¥ Health Check with Auto-Recovery
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            echo "ğŸ¥ Waiting for app..."

            # Erste Versuche (0-15)
            ATTEMPT=0
            MAX_ATTEMPTS=30
            RECOVERY_ATTEMPTED=false

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              
              # PrÃ¼fe Health Check
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Healthy!"
                curl -fsS http://localhost:8080/actuator/health
                exit 0
              elif [ "$HTTP_CODE" = "503" ] && [ "$RECOVERY_ATTEMPTED" = "false" ] && [ $ATTEMPT -ge 10 ]; then
                echo "âš ï¸  HTTP 503 detected - attempting auto-recovery..."
                echo ""
                echo "ğŸ”§ Step 1: Checking PostgreSQL..."
                if ! sudo -u postgres psql -d storedb -c "SELECT 1;" &>/dev/null; then
                  echo "   âŒ DB not responding, restarting PostgreSQL..."
                  sudo systemctl restart postgresql
                  sleep 3
                else
                  echo "   âœ… PostgreSQL is responding"
                fi
                
                echo ""
                echo "ğŸ”§ Step 2: Restarting StoreBackend service..."
                sudo systemctl restart storebackend
                RECOVERY_ATTEMPTED=true
                echo "   âœ… Service restarted, continuing health checks..."
                sleep 5
                continue
              fi
              
              echo "â³ Attempt $ATTEMPT/$MAX_ATTEMPTS (HTTP $HTTP_CODE)..."
              sleep 2
            done

            # Wenn alle Versuche fehlgeschlagen sind
            echo ""
            echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
            echo ""
            echo "ğŸ“Š Service Status:"
            sudo systemctl status storebackend --no-pager -l | head -20 || true
            echo ""
            echo "âŒ Last 120 log lines:"
            sudo journalctl -u storebackend -n 120 --no-pager || true
            echo ""
            echo "ğŸ” Database Status:"
            sudo systemctl status postgresql --no-pager | head -10 || true
            
            exit 1

      - name: ğŸ“Š Show Service Status
        if: always()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ğŸ“Š Service Status:"
            sudo systemctl status storebackend --no-pager || true
            echo ""
            echo "ğŸ“‹ Recent logs:"
            sudo journalctl -u storebackend -n 60 --no-pager || true
