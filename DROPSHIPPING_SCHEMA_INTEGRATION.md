# ‚úÖ DROPSHIPPING SCHEMA INTEGRATION - COMPLETE

**Status:** ‚úÖ FERTIG - Keine separate Migration n√∂tig!  
**Datum:** 27.02.2026

---

## üéØ WICHTIG: KEINE V10 MIGRATION!

Alle Dropshipping-Tabellen sind **direkt in schema.sql integriert**:

- ‚úÖ `scripts/db/schema.sql` (PostgreSQL Production)
- ‚úÖ `src/main/resources/schema.sql` (H2 Local Development)

**Kein separates Migrations-File n√∂tig!**

---

## üìç WO SIND DIE DROPSHIPPING-TABELLEN?

### **1. PostgreSQL schema.sql (`scripts/db/schema.sql`)**

**Zeile 1756-1776:** `dropshipping_sources` Tabelle
```sql
CREATE TABLE IF NOT EXISTS dropshipping_sources (
    id BIGSERIAL PRIMARY KEY,
    variant_id BIGINT NOT NULL,
    supplier_url VARCHAR(1000) NOT NULL,
    supplier_name VARCHAR(255),
    purchase_price DECIMAL(10, 2) NOT NULL,
    estimated_shipping_days INTEGER,
    supplier_sku VARCHAR(255),
    notes TEXT,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_dropshipping_variant 
        FOREIGN KEY (variant_id) REFERENCES product_variants(id) ON DELETE CASCADE,
    CONSTRAINT fk_dropshipping_creator 
        FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT uk_dropshipping_sources_variant 
        UNIQUE (variant_id)
);
```

**Zeile 1785-1804:** `order_items` Fulfillment-Felder (PostgreSQL DO-Block)
```sql
DO $$ BEGIN
    IF NOT EXISTS (...) THEN
        ALTER TABLE order_items ADD COLUMN fulfillment_status VARCHAR(50) DEFAULT 'PENDING';
    END IF;
    -- + 6 weitere Felder
END $$;
```

**Zeile 1806:** Index f√ºr Performance
```sql
CREATE INDEX IF NOT EXISTS idx_order_items_fulfillment_status ON order_items(fulfillment_status);
```

### **2. H2 schema.sql (`src/main/resources/schema.sql`)**

**Zeile 874-890:** `dropshipping_sources` Tabelle
```sql
CREATE TABLE IF NOT EXISTS dropshipping_sources (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    variant_id BIGINT NOT NULL,
    supplier_url VARCHAR(1000) NOT NULL,
    supplier_name VARCHAR(255),
    purchase_price DECIMAL(10, 2) NOT NULL,
    estimated_shipping_days INTEGER,
    supplier_sku VARCHAR(255),
    notes CLOB,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_dropshipping_variant 
        FOREIGN KEY (variant_id) REFERENCES product_variants(id) ON DELETE CASCADE,
    CONSTRAINT fk_dropshipping_creator 
        FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT uk_dropshipping_sources_variant 
        UNIQUE (variant_id)
);
```

**Zeile 898-905:** `order_items` Fulfillment-Felder (H2 ALTER TABLE)
```sql
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS fulfillment_status VARCHAR(50) DEFAULT 'PENDING';
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS supplier_order_id VARCHAR(255);
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS supplier_tracking_number VARCHAR(255);
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS supplier_carrier VARCHAR(100);
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS ordered_from_supplier_at TIMESTAMP;
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS fulfilled_at TIMESTAMP;
ALTER TABLE order_items ADD COLUMN IF NOT EXISTS fulfillment_notes CLOB;
```

---

## üîç UNTERSCHIEDE PostgreSQL vs H2

| Feature | PostgreSQL | H2 |
|---------|------------|-----|
| **Primary Key** | `BIGSERIAL` | `BIGINT GENERATED BY DEFAULT AS IDENTITY` |
| **Text Feld** | `TEXT` | `CLOB` |
| **Conditional ALTER** | `DO $$ BEGIN ... END $$;` | `ALTER TABLE ... IF NOT EXISTS` |
| **Comments** | `COMMENT ON TABLE ...` | Nicht unterst√ºtzt |

**Beide sind funktional identisch!**

---

## ‚úÖ VERIFICATION CHECKLIST

### **PostgreSQL schema.sql pr√ºfen:**
```bash
grep -n "dropshipping_sources" scripts/db/schema.sql
# Erwartung: Zeile 1756 (CREATE TABLE)
# Erwartung: Zeile 1808 (COMMENT ON TABLE)

grep -n "fulfillment_status" scripts/db/schema.sql
# Erwartung: Zeile 1785 (ALTER TABLE im DO-Block)
# Erwartung: Zeile 1811 (COMMENT ON COLUMN)
```

### **H2 schema.sql pr√ºfen:**
```bash
grep -n "dropshipping_sources" src/main/resources/schema.sql
# Erwartung: Zeile 874 (CREATE TABLE)

grep -n "fulfillment_status" src/main/resources/schema.sql
# Erwartung: Zeile 898 (ALTER TABLE)
```

### **Backend Kompilierung:**
```bash
mvn clean compile -DskipTests
# Erwartung: BUILD SUCCESS
```

### **Lokaler Start:**
```bash
mvn spring-boot:run
# Erwartung: Tomcat starts without schema errors
# H2 erstellt automatisch alle Tabellen aus schema.sql
```

---

## üö® WICHTIG F√úR DEPLOYMENT

### **Production (PostgreSQL):**
```bash
# 1. Pull neueste Version
git pull origin main

# 2. Backup Database
pg_dump storedb > backup_before_dropshipping.sql

# 3. Deploy neues Backend
mvn clean package -DskipTests
scp target/storeBackend-*.jar server:/opt/app/

# 4. Starte Backend
sudo systemctl restart storebackend

# 5. Pr√ºfe Logs
tail -f /var/log/storebackend.log | grep "dropshipping"

# 6. Verifiziere Schema
psql -U postgres -d storedb -c "\d dropshipping_sources"
# Erwartung: Tabelle existiert mit allen Spalten
```

### **Local Development (H2):**
```bash
# 1. Starte Backend
mvn spring-boot:run

# 2. H2 Console √∂ffnen
open http://localhost:8080/h2-console

# 3. Verbinden:
JDBC URL: jdbc:h2:~/storedb
User: sa
Password: (leer)

# 4. Pr√ºfe Schema:
SELECT * FROM dropshipping_sources LIMIT 1;
SELECT * FROM information_schema.columns 
WHERE table_name = 'ORDER_ITEMS' 
AND column_name = 'FULFILLMENT_STATUS';
```

---

## üîÑ ROLLBACK (Falls n√∂tig)

### **Wenn etwas schiefgeht:**

#### **Option 1: Schema-√Ñnderungen r√ºckg√§ngig machen**
```sql
-- PostgreSQL
DROP TABLE IF EXISTS dropshipping_sources CASCADE;
ALTER TABLE order_items DROP COLUMN IF EXISTS fulfillment_status;
ALTER TABLE order_items DROP COLUMN IF EXISTS supplier_order_id;
ALTER TABLE order_items DROP COLUMN IF EXISTS supplier_tracking_number;
ALTER TABLE order_items DROP COLUMN IF EXISTS supplier_carrier;
ALTER TABLE order_items DROP COLUMN IF EXISTS ordered_from_supplier_at;
ALTER TABLE order_items DROP COLUMN IF EXISTS fulfilled_at;
ALTER TABLE order_items DROP COLUMN IF EXISTS fulfillment_notes;
DROP INDEX IF EXISTS idx_order_items_fulfillment_status;
```

#### **Option 2: Git Revert**
```bash
# Finde Commit vor Dropshipping
git log --oneline | grep -i dropshipping

# Revert
git revert <commit-hash>

# Oder: Reset zu vorherigem Zustand
git reset --hard HEAD~1
```

#### **Option 3: Restore Backup**
```bash
# Restore Database Backup
psql -U postgres -d storedb < backup_before_dropshipping.sql
```

---

## üìä SCHEMA VALIDATION QUERIES

### **Pr√ºfe ob alles korrekt erstellt wurde:**

```sql
-- 1. dropshipping_sources Tabelle existiert?
SELECT table_name, table_type 
FROM information_schema.tables 
WHERE table_name = 'dropshipping_sources';
-- Erwartung: 1 Zeile

-- 2. Alle Spalten vorhanden?
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'dropshipping_sources'
ORDER BY ordinal_position;
-- Erwartung: 11 Zeilen (id, variant_id, supplier_url, ...)

-- 3. Unique Constraint auf variant_id?
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'dropshipping_sources'
AND constraint_type = 'UNIQUE';
-- Erwartung: uk_dropshipping_sources_variant

-- 4. Foreign Keys korrekt?
SELECT constraint_name, table_name, column_name
FROM information_schema.key_column_usage
WHERE table_name = 'dropshipping_sources';
-- Erwartung: fk_dropshipping_variant, fk_dropshipping_creator

-- 5. order_items Felder vorhanden?
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'order_items'
AND column_name IN (
    'fulfillment_status', 
    'supplier_order_id', 
    'supplier_tracking_number',
    'supplier_carrier',
    'ordered_from_supplier_at',
    'fulfilled_at',
    'fulfillment_notes'
);
-- Erwartung: 7 Zeilen

-- 6. Index auf fulfillment_status?
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'order_items'
AND indexname = 'idx_order_items_fulfillment_status';
-- Erwartung: 1 Zeile
```

---

## ‚úÖ SCHEMA INTEGRATION COMPLETE

**Summary:**
- ‚úÖ V10 Migration-Datei gel√∂scht
- ‚úÖ Dropshipping-Tabellen in beide schema.sql integriert
- ‚úÖ PostgreSQL: DO-Block f√ºr idempotente ALTER TABLE
- ‚úÖ H2: IF NOT EXISTS f√ºr idempotente ALTER TABLE
- ‚úÖ Alle Foreign Keys + Constraints vorhanden
- ‚úÖ Performance-Indizes erstellt
- ‚úÖ Documentation aktualisiert

**Status:** üöÄ READY TO USE

**Beim n√§chsten Backend-Start werden die Tabellen automatisch erstellt!**

