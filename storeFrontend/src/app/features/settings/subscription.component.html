<div class="subscription-page">
  <div class="page-header">
    <h1>Abonnement & Pl√§ne</h1>
    <p>Verwalten Sie Ihr Abonnement und upgraden Sie Ihren Plan</p>
  </div>

  <!-- Aktueller Plan -->
  <div class="current-plan-section" *ngIf="currentSubscription">
    <h2>Ihr aktueller Plan</h2>
    <div class="current-plan-card">
      <div class="plan-badge" [class.plan-free]="currentSubscription.plan === 'FREE'"
           [class.plan-pro]="currentSubscription.plan === 'PRO'"
           [class.plan-enterprise]="currentSubscription.plan === 'ENTERPRISE'">
        {{ getPlanName(currentSubscription.plan) }}
      </div>

      <div class="plan-info">
        <div class="info-row">
          <span class="label">Status:</span>
          <span class="status-badge" [class.status-active]="currentSubscription.status === 'ACTIVE'"
                [class.status-cancelled]="currentSubscription.status === 'CANCELLED'">
            {{ getStatusLabel(currentSubscription.status) }}
          </span>
        </div>

        <div class="info-row" *ngIf="currentSubscription.amount > 0">
          <span class="label">Preis:</span>
          <span class="value">{{ currentSubscription.amount | number:'1.2-2' }} ‚Ç¨ / {{ currentSubscription.billingCycle === 'MONTHLY' ? 'Monat' : 'Jahr' }}</span>
        </div>

        <div class="info-row" *ngIf="currentSubscription.renewalDate">
          <span class="label">N√§chste Verl√§ngerung:</span>
          <span class="value">{{ currentSubscription.renewalDate | date:'dd.MM.yyyy' }}</span>
        </div>

        <div class="info-row" *ngIf="currentSubscription.paymentMethod">
          <span class="label">Zahlungsmethode:</span>
          <span class="value">{{ getPaymentMethodLabel(currentSubscription.paymentMethod) }}</span>
        </div>
      </div>

      <div class="plan-actions" *ngIf="currentSubscription.plan !== 'ENTERPRISE'">
        <button class="btn btn-primary" (click)="showUpgradeOptions = true">
          <span class="icon">‚¨ÜÔ∏è</span> Plan upgraden
        </button>
      </div>
    </div>
  </div>

  <!-- Keine Subscription vorhanden -->
  <div class="no-subscription-section" *ngIf="!currentSubscription && !loadingSubscription">
    <div class="info-box">
      <span class="icon">‚ÑπÔ∏è</span>
      <p>Sie haben derzeit noch kein aktives Abonnement. W√§hlen Sie einen Plan aus, um zu starten!</p>
    </div>
  </div>

  <!-- Verf√ºgbare Pl√§ne -->
  <div class="plans-section">
    <h2>Verf√ºgbare Pl√§ne</h2>
    <p class="section-description">W√§hlen Sie den Plan, der am besten zu Ihrem Gesch√§ft passt</p>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loadingPlans">
      <div class="spinner"></div>
      <p>Pl√§ne werden geladen...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="plansError && !loadingPlans">
      <span class="icon">‚ö†Ô∏è</span>
      <p>{{ plansError }}</p>
      <button class="btn btn-secondary" (click)="loadAvailablePlans()">Erneut versuchen</button>
    </div>

    <!-- Plans Grid -->
    <div *ngIf="!loadingPlans && !plansError && availablePlans.length > 0">
      <div class="billing-toggle">
        <label class="toggle-label">
          <span [class.active]="selectedBillingCycle === 'MONTHLY'">Monatlich</span>
          <input type="checkbox"
                 [checked]="selectedBillingCycle === 'YEARLY'"
                 (change)="toggleBillingCycle()">
          <span class="toggle-switch"></span>
          <span [class.active]="selectedBillingCycle === 'YEARLY'">
            J√§hrlich
            <span class="savings-badge">Spare bis zu 20%</span>
          </span>
        </label>
      </div>

      <div class="plans-grid">
        <div *ngFor="let plan of availablePlans"
             class="plan-card"
             [class.popular]="plan.popular"
             [class.current]="currentSubscription?.plan === plan.plan">

          <div class="popular-badge" *ngIf="plan.popular">Am beliebtesten</div>
          <div class="current-badge" *ngIf="currentSubscription?.plan === plan.plan">Aktueller Plan</div>

          <div class="plan-header">
            <h3>{{ plan.name }}</h3>
            <p class="plan-description">{{ plan.description }}</p>
          </div>

          <div class="plan-pricing">
            <div class="price">
              <span class="amount">{{ (selectedBillingCycle === 'YEARLY' ? plan.yearlyPrice : plan.monthlyPrice) | number:'1.2-2' }}</span>
              <span class="currency">‚Ç¨</span>
            </div>
            <div class="billing-period">
              pro {{ selectedBillingCycle === 'YEARLY' ? 'Jahr' : 'Monat' }}
            </div>
            <div class="yearly-savings" *ngIf="selectedBillingCycle === 'YEARLY' && plan.plan !== 'FREE'">
              Ersparnis: {{ getYearlySavings(plan.plan) | number:'1.2-2' }} ‚Ç¨
            </div>
          </div>

          <div class="plan-features">
            <ul>
              <li>
                <span class="icon">{{ plan.features.maxStores === -1 ? '‚àû' : plan.features.maxStores }}</span>
                {{ plan.features.maxStores === -1 ? 'Unbegrenzte' : plan.features.maxStores }} Shops
              </li>
              <li>
                <span class="icon">{{ plan.features.maxProducts === -1 ? '‚àû' : plan.features.maxProducts }}</span>
                {{ plan.features.maxProducts === -1 ? 'Unbegrenzte' : plan.features.maxProducts }} Produkte
              </li>
              <li>
                <span class="icon">{{ plan.features.maxOrders === -1 ? '‚àû' : plan.features.maxOrders }}</span>
                {{ plan.features.maxOrders === -1 ? 'Unbegrenzte' : plan.features.maxOrders }} Bestellungen
              </li>
              <li [class.feature-disabled]="!plan.features.customDomain">
                <span class="icon">{{ plan.features.customDomain ? '‚úì' : '‚úó' }}</span>
                Custom Domain
              </li>
              <li [class.feature-disabled]="!plan.features.analytics">
                <span class="icon">{{ plan.features.analytics ? '‚úì' : '‚úó' }}</span>
                Analytics & Reports
              </li>
              <li [class.feature-disabled]="!plan.features.priority_support">
                <span class="icon">{{ plan.features.priority_support ? '‚úì' : '‚úó' }}</span>
                Priority Support
              </li>
              <li [class.feature-disabled]="!plan.features.api_access">
                <span class="icon">{{ plan.features.api_access ? '‚úì' : '‚úó' }}</span>
                API Zugang
              </li>
              <li [class.feature-disabled]="!plan.features.multiLanguage">
                <span class="icon">{{ plan.features.multiLanguage ? '‚úì' : '‚úó' }}</span>
                Mehrsprachig
              </li>
              <li [class.feature-disabled]="!plan.features.customBranding">
                <span class="icon">{{ plan.features.customBranding ? '‚úì' : '‚úó' }}</span>
                Custom Branding
              </li>
            </ul>
          </div>

          <div class="plan-action">
            <button *ngIf="canUpgradeToThisPlan(plan.plan)"
                    class="btn btn-upgrade"
                    [class.btn-primary]="plan.popular"
                    (click)="selectPlanForUpgrade(plan)"
                    [disabled]="upgrading">
              {{ upgrading ? 'Wird verarbeitet...' : 'Jetzt upgraden' }}
            </button>
            <button *ngIf="currentSubscription?.plan === plan.plan"
                    class="btn btn-current" disabled>
              Aktueller Plan
            </button>
            <button *ngIf="!canUpgradeToThisPlan(plan.plan) && currentSubscription?.plan !== plan.plan"
                    class="btn btn-disabled" disabled>
              Downgrade nicht m√∂glich
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Plans Available -->
    <div class="no-plans-state" *ngIf="!loadingPlans && !plansError && availablePlans.length === 0">
      <p>Derzeit sind keine Pl√§ne verf√ºgbar.</p>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Upgrade zu {{ selectedPlan?.name }}</h2>
        <button class="close-btn" (click)="closePaymentModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="upgrade-summary">
          <h3>Zusammenfassung</h3>
          <div class="summary-row">
            <span>Plan:</span>
            <strong>{{ selectedPlan?.name }}</strong>
          </div>
          <div class="summary-row">
            <span>Abrechnungszyklus:</span>
            <strong>{{ selectedBillingCycle === 'YEARLY' ? 'J√§hrlich' : 'Monatlich' }}</strong>
          </div>
          <div class="summary-row total">
            <span>Gesamtpreis:</span>
            <strong>{{ calculateUpgradePrice() | number:'1.2-2' }} ‚Ç¨</strong>
          </div>
        </div>

        <div class="payment-method-selection">
          <h3>Zahlungsmethode w√§hlen</h3>
          <div class="payment-methods">
            <label class="payment-method-option">
              <input type="radio"
                     name="paymentMethod"
                     value="BANK_TRANSFER"
                     [(ngModel)]="selectedPaymentMethod">
              <div class="method-content">
                <span class="icon">üè¶</span>
                <div class="method-info">
                  <strong>Bank√ºberweisung</strong>
                  <small>Sie erhalten die Bankdaten nach der Bestellung</small>
                </div>
              </div>
            </label>

            <label class="payment-method-option">
              <input type="radio"
                     name="paymentMethod"
                     value="STRIPE"
                     [(ngModel)]="selectedPaymentMethod">
              <div class="method-content">
                <span class="icon">üí≥</span>
                <div class="method-info">
                  <strong>Kreditkarte (Stripe)</strong>
                  <small>Sichere Zahlung mit Stripe</small>
                </div>
              </div>
            </label>

            <label class="payment-method-option">
              <input type="radio"
                     name="paymentMethod"
                     value="PAYPAL"
                     [(ngModel)]="selectedPaymentMethod">
              <div class="method-content">
                <span class="icon">üÖøÔ∏è</span>
                <div class="method-info">
                  <strong>PayPal</strong>
                  <small>Bezahlen mit PayPal</small>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="bank-transfer-info" *ngIf="paymentIntent?.bankTransferDetails">
          <h3>√úberweisungsdaten</h3>
          <div class="bank-details">
            <div class="detail-row">
              <span class="label">Empf√§nger:</span>
              <strong>{{ paymentIntent?.bankTransferDetails?.accountHolder }}</strong>
            </div>
            <div class="detail-row">
              <span class="label">IBAN:</span>
              <strong>{{ paymentIntent?.bankTransferDetails?.iban }}</strong>
            </div>
            <div class="detail-row">
              <span class="label">BIC:</span>
              <strong>{{ paymentIntent?.bankTransferDetails?.bic }}</strong>
            </div>
            <div class="detail-row">
              <span class="label">Betrag:</span>
              <strong>{{ paymentIntent?.bankTransferDetails?.amount | number:'1.2-2' }} {{ paymentIntent?.bankTransferDetails?.currency }}</strong>
            </div>
            <div class="detail-row">
              <span class="label">Verwendungszweck:</span>
              <strong class="reference">{{ paymentIntent?.bankTransferDetails?.reference }}</strong>
            </div>
          </div>
          <p class="bank-transfer-note">
            ‚ö†Ô∏è Bitte verwenden Sie unbedingt den angegebenen Verwendungszweck, damit wir Ihre Zahlung zuordnen k√∂nnen.
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closePaymentModal()" [disabled]="upgrading">
          Abbrechen
        </button>
        <button class="btn btn-primary"
                (click)="confirmUpgrade()"
                [disabled]="!selectedPaymentMethod || upgrading">
          {{ upgrading ? 'Wird verarbeitet...' : 'Jetzt upgraden' }}
        </button>
      </div>
    </div>
  </div>
</div>
